---
title: "SCM_owd"
author: "Greta Lotz"
date: "2024-04-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
library(readxl)

owid_data <- read_excel("owid-co2-data.xlsx")
iea_data <- read_excel("iea.xlsx", sheet = 2)

# Prepare OWID data (generalized for all countries) coal_co2_per_capita, gas_co2_per_capita, oil_co2_per_capita

# Create a vector with the names of the countries
countries <- c("Australia", "Belgium", "Canada", "Denmark", 
               "France", "Greece", "Iceland", "Japan", 
               "New Zealand", "Poland", "Portugal", "Spain", 
               "Switzerland", "United States", "Norway")

# Filter the data frame for the list of countries and select the variables
owid_data <- owid_data %>%
  filter(country %in% countries, year >= 1960, year <= 2005) %>%
  filter(country %in% countries) %>%
  select(country, year, coal_co2_per_capita, gas_co2_per_capita, oil_co2_per_capita, co2_per_capita) %>%
  mutate(
    year = as.numeric(year),
    co2_per_capita = as.numeric(co2_per_capita),
    gas_co2_per_capita = as.numeric(gas_co2_per_capita),
    oil_co2_per_capita = as.numeric(oil_co2_per_capita),
    coal_co2_per_capita = as.numeric(coal_co2_per_capita)
  )

# View the filtered and selected data
print(owid_data)


```


```{r}
# Prepare IEA data (generalized for all countries)
iea_all_countries_long <- iea_data %>%
  gather(key = "year", value = "value", -c(country)) %>%
  filter(year >= 1960 & year <= 2005) %>%
  rename(co2_trans_percent = value)  %>%
  mutate( year = as.numeric(year))

```


```{r version 1}
owid_data_all_co2 <- owid_data %>%
select(country, year, co2_per_capita)
# Merge and calculate CO2 transport per capita for all countries
carbontax_owid <- owid_data_all_co2 %>%
  left_join(iea_all_countries_long, by = c("country", "year")) %>%
  mutate(
    year = as.numeric(year),
    co2_per_capita = as.numeric(co2_per_capita),
    co2_trans_percent = as.numeric(co2_trans_percent),
    CO2_transport_capita = co2_per_capita * co2_trans_percent
  ) %>%
  select(-co2_per_capita, -co2_trans_percent)  # Removing intermediate columns

```


```{r version 2}
# Merge and calculate CO2 transport per capita for all countries
owid_data_combined <- owid_data %>%
  select(country, year, coal_co2_per_capita, gas_co2_per_capita, oil_co2_per_capita)%>%
  mutate(co2_per_capita = coal_co2_per_capita + gas_co2_per_capita + oil_co2_per_capita)


carbontax_owid <- owid_data_combined %>%
  left_join(iea_all_countries_long, by = c("country", "year")) %>%
  mutate(
    year = as.numeric(year),
    co2_per_capita = as.numeric(co2_per_capita),
    co2_trans_percent = as.numeric(co2_trans_percent),
    CO2_transport_capita = co2_per_capita * co2_trans_percent
  ) %>%
  select(-co2_per_capita, -co2_trans_percent)  # Removing intermediate columns
```



```{r}
library(dplyr)

# Assuming carbontax and carbontax_owid are already loaded and prepared

# Merge carbontax with the new CO2_transport_capita values
carbontax_updated <- carbontax %>%
  left_join(carbontax_owid %>% select(country, year, CO2_transport_capita),
            by = c("country", "year")) %>%
  # Replace the old CO2_transport_capita column with the new one
  mutate(CO2_transport_capita = coalesce(CO2_transport_capita.y, CO2_transport_capita.x)) %>%
  # Select the original columns of carbontax, now including the updated CO2_transport_capita
  select(Countryno, country, year, CO2_transport_capita, GDP_per_capita, gas_cons_capita, vehicles_capita, urban_pop, pop_density)

# View the updated dataframe
print(carbontax_updated)

```

```{r}
dataprep.out <-
              dataprep(foo = carbontax_updated,
                       predictors = c("GDP_per_capita" , "gas_cons_capita" , "vehicles_capita" ,
                                      "urban_pop") ,
                       predictors.op = "mean" ,
                       time.predictors.prior = 1980:1990 ,
                       special.predictors = list(
                         list("CO2_transport_capita" , 1990 , "mean"),
                         list("CO2_transport_capita" , 1980 , "mean"),
                         list("CO2_transport_capita" , 1970 , "mean")
                                                ),
                       dependent = "CO2_transport_capita",
                       unit.variable = "Countryno",
                       unit.names.variable = "country",
                       time.variable = "year",
                       treatment.identifier = 10, # no 10 Norway
                       controls.identifier = c(1:9, 11:15),
                       time.optimize.ssr = 1960:1990,
                       time.plot = 1960:2005
                       )


###################################################
 synth.out <- synth(data.prep.obj = dataprep.out,
                    method = "All")
	
###################################################
 synth.tables <- synth.tab(dataprep.res = dataprep.out,
                           synth.res = synth.out
                           )

###################################################
### Table 1: CO2 Emissions From Transport Predictor Means Before Tax Reform	
###################################################
 synth.tables$tab.pred[1:7, ]
 
###################################################
### Table 2: Country Weights in Synthetic Norway
###################################################
 synth.tables$tab.w[1:14, ]

###################################################
### Figure 4: Path Plot of per capita CO2 Emissions from Transport
###################################################
  path.plot(synth.res = synth.out,
           dataprep.res = dataprep.out,
           Ylab = "Metric tons per capita (CO2 from transport)",
           Xlab = "Year",
           Ylim = c(0,5),
           Legend = c("Norway","synthetic Norway"),
           Legend.position = "bottomright"
           )
# Add line 
abline(v=1991,lty="dotted",lwd=2)
arrows(1987,1.0,1989,1.0,col="black",length=.1)	
Cex.set <- 1
text(1983,1.0,"Carbon tax",cex=Cex.set)



###################################################
### Figure 5: Gap in per capita CO2 Emissions from Transport between Sweden and Synthetic Sweden
###################################################
 gaps.plot(synth.res = synth.out,
           dataprep.res = dataprep.out,
           Ylab = "Gap in metric tons per capita (CO2 from transport)",
           Xlab = "Year",
           Ylim = c(-0.8,1),
           Main = NA
           )

#Add line
abline(v=1991,lty="dotted",lwd=2)
arrows(1987,-0.5,1989,-0.5,col="black",length=.1)	
Cex.set <- 1
text(1983,-0.5,"Carbon tax",cex=Cex.set)
```

```{r}
# Open a PNG device
png("gap_plot.jpg", width = 800, height = 600, res = 300)



# Create the plot
gaps.plot(synth.res = synth.out,
          dataprep.res = dataprep.out,
          Ylab = "Gap in metric tons per capita (CO2 from transport)",
          Xlab = "Year",
          Ylim = c(-0.8,1),
          Main = NA)

# Add additional elements to the plot
abline(v = 1991, lty = "dotted", lwd = 2)
arrows(1987, -0.5, 1989, -0.5, col = "black", length = 0.1)  
text(1981, -0.5, "Carbon tax", cex = 1)

# Close the PNG device
dev.off()

```



```{r Weights table}
library(dplyr)
library(flextable)
library(officer)

weights_df <-  synth.tables$tab.w

# Assuming weights_df is your original data frame
# Rename columns and drop 'unit.numbers'
weights_df <- weights_df %>%
  select(
    Country = unit.names,  # Rename unit.names to Country
    Weight = w.weights     # Rename w.weights to Weight
  ) %>%
  mutate(Weight = round(Weight, 3))  # Optionally round the weights to three decimal places


# Round the weights to three decimal places
weights_df$Weight <- round(weights_df$Weight, 3)

# Split the data frame into two halves for two columns
half <- ceiling(nrow(weights_df) / 2)
first_half <- weights_df[1:half, ]
second_half <- weights_df[(half + 1):nrow(weights_df), ]

# Combine the two halves
combined_weights <- cbind(first_half, second_half)
combined_weights <- setNames(combined_weights, c("Country1", "Weight1", "Country2", "Weight2"))


# Create a flextable
ft <- flextable(combined_weights)
ft <- set_header_df(ft, mapping = data.frame(values = c("Country", "Weight", "Country", "Weight"), col_keys = names(combined_weights)))
ft <- theme_booktabs(ft)  # Adds nice lines; modify if you prefer no lines
ft <- fontsize(ft, size = 12, part = "all")
ft <- font(ft, fontname = "Times New Roman", part = "all")

# Create a Word document and add the flextable
doc <- read_docx()
doc <- body_add_flextable(doc, value = ft)

# Save the Word document
file_path <- "../Word_Document.docx" 
print(doc, target = file_path)

```




```{r regression table 1}
library(knitr)
library(kableExtra)

table <- synth.tables$tab.pred

# Renaming the rows
rownames(table) <- c(
  "GDP per capita",
  "Gasoline consumption per capita",
  "Motor vehicles (per 1,000 people)",
  "Urban population",
  "1990 CO2 from transport per capita",
  "1980 CO2 from transport per capita",
  "1970 CO2 from transport per capita"
)


# Assuming your matrix 'table' is defined as you've shown before
# Convert the matrix to a data frame for easier manipulation
table_df <- as.data.frame(table)

# Round the numeric data to 1 decimal place
table_df <- round(table_df, 1)

# Renaming the columns correctly for the data frame
names(table_df) <- c("Norway", "Synth. Norway", "OECD sample")

# Add a new column at the beginning for the row names from the matrix
table_df <- cbind("Variables" = rownames(table), table_df)

# Update rownames to NULL to avoid duplication in kable output
rownames(table_df) <- NULL

# Generate the table with knitr::kable
kable_output <- kable(table_df, format = "html", escape = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = "striped", position = "center")

# Render the kable output for R Markdown or print to the console
print(kable_output)

```

```{r regression table 2}
library(flextable)
library(officer)

# Create a flextable from the data frame
flex_table <- flextable(table_df)

# Set the font size and family for the entire table
flex_table <- flex_table %>%
  font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all")

# Optional: Style the header and add stripes for better readability
#flex_table <- theme_booktabs(flex_table) %>% # Adds booktabs-style horizontal lines
 # bold(part = "header") %>% # Make headers bold
  #autofit() %>% # Fit the table to content widths
  #add_header_lines(values = "Summary of Variables")

# Check the table in R console (optional)
print(flex_table)

# Create a new Word document
doc <- read_docx()

# Add the flextable to the document
doc <- body_add_flextable(doc, value = flex_table)

# Save the Word document
file_path <- "Word_Document.docx"
print(doc, target = file_path)


```

